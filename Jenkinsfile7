pipeline {
    agent any

    environment {
        IMAGE_NAME = "selenium-test"
    }

    stages {

        stage('Build Docker Image') {
            steps {
                script {
                    // Build Docker image
                    sh '''
                        docker build -t $IMAGE_NAME .
                        docker images
                    '''
                }
            }
        }

        stage('Run Selenium Tests') {
            steps {
                script {
                    // Run the container and NEVER fail pipe if Selenium returns exit code 1
                    // (Tests may fail; still we want pipeline to continue)
                    sh '''
                        set +e
                        docker run $IMAGE_NAME
                        EXIT_CODE=$?
                        echo "Selenium Test Exit Code: $EXIT_CODE"
                        exit 0
                    '''
                }
            }
        }
    }

    post {
        always {
            // Cleanup (ignore errors)
            sh(returnStatus: true, script: "docker system prune -af || true")
        }
    }
}
